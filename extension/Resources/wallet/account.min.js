var AccountSettings=new function(){function b(n){var m=n.lastIndexOf("@");var l=n.lastIndexOf(".");return(m<l&&m>0&&n.indexOf("@@")==-1&&l>2&&(n.length-l)>2)}function c(l){try{var m=window.applicationCache;console.log("Clear Cache Manifest");m.addEventListener("updateready",function(o){m.swapCache();if(l){l()}},false);m.addEventListener("noupdate",function(o){if(l){l()}},false);m.addEventListener("error",function(o){if(l){l()}},false);m.update()}catch(n){console.log(n);if(l){l()}}}function i(l,p,n,o,m){n=$.trim(n);if(n.length==0){MyWallet.makeNotice("error","misc-error",l+": Invalid value");return}if(n.length==0){MyWallet.makeNotice("error",p+"-error",data.responseText);if(m){m()}return}MyWallet.setLoadingText(l);MyWallet.securePost("wallet",{length:(n+"").length,payload:n+"",method:p},function(q){MyWallet.makeNotice("success",p+"-success",q);if(o){o()}},function(q){MyWallet.makeNotice("error",p+"-error",q.responseText);if(m){m()}})}function h(){if(MyWallet.getDoubleEncryption()){$(".double-encryption-off").hide();$(".double-encryption-on").show()}else{$(".double-encryption-on").hide();$(".double-encryption-off").show()}$("#double-password").val("");$("#double-password2").val("")}function k(){$("#password_mnemonic1").find("span").empty();$("#password_mnemonic2").find("span").empty()}function f(){k();var m=$("#password_mnemonic1");var l=$("#password_mnemonic2");loadScript("wallet/mnemonic.js",function(){MyWallet.getMainPassword(function(n){MyWallet.getSecondPassword(function(o){try{m.show().find("span").text(mn_encode_pass(n));if(o){l.show().find("span").text(mn_encode_pass(o))}else{l.hide()}}catch(p){console.log(p);e()}},function(){e()})},function(){e()})})}this.bind=function(){h();d();a()};this.init=function(l,n,m){MyWallet.setLoadingText("Loading Account Settings");if(!l.is(":empty")){AccountSettings.bind();n();return}$.ajax({type:"GET",url:root+"wallet/account-settings-template",data:{format:"plain"},success:function(o){try{l.html(o);AccountSettings.bind();n()}catch(p){console.log(p);m()}},error:function(o){MyWallet.makeNotice("error","misc-error","Error Downloading Account Settings Template");m()}})};function a(){$('a[data-toggle="tab"]').unbind().on("show",function(l){$(l.target.hash).trigger("show")});MyWallet.setLoadingText("Getting Wallet Info");MyWallet.securePost("wallet",{method:"get-info",format:"json"},function(r){if(r.email!=null){$("#wallet-email").val(r.email);$(".my-email").text(r.email)}$("#wallet-phrase").val(r.phrase);$("#two-factor-select").val(r.auth_type);$(".two-factor").hide();$(".two-factor.t"+r.auth_type).show(200);var s=$("#notifications-type");s.find(":checkbox").prop("checked",false);s.find('[class^="type"]').hide();for(var t in r.notifications_type){var u=r.notifications_type[t];s.find(':checkbox[value="'+u+'"]').prop("checked",true);s.find(".type-"+u).show()}$(".logl").hide();$(".logl.l"+r.logging_level).show();$("#logging-level").val(r.logging_level);$("#notifications-confirmations").val(r.notifications_confirmations);$("#notifications-on").val(r.notifications_on);if(r.alias!=null&&r.alias.length>0){$("#wallet-alias").val(r.alias);$(".alias").text("https://blockchain.info/wallet/"+r.alias);$(".alias").show(200)}var m=$("#local_currency").empty();for(var v in r.currencies){var y=r.currencies[v];m.append('<option value="'+v+'">'+y+"</option>")}m.val(r.currency);var p=$("#language_select").empty();for(var q in r.languages){var x=r.languages[q];p.append('<option value="'+q+'">'+x+"</option>")}p.val(r.language);if(r.auto_email_backup==1){$("#auto-email-backup").prop("checked",true)}else{$("#auto-email-backup").prop("checked",false)}if(r.never_save_auth_type==1){$("#never-save-auth-type").prop("checked",true)}else{$("#never-save-auth-type").prop("checked",false)}if(r.google_secret_url!=null&&r.google_secret_url.length>0){loadScript("wallet/jquery.qrcode.min.js",function(){$("#wallet-google-qr").empty().qrcode({width:300,height:300,text:r.google_secret_url})})}$("#wallet-http-url").val(r.http_url);$("#wallet-skype").val(r.skype_username);$("#wallet-boxcar").val(r.boxcar_email);$("#wallet-yubikey").val(r.yubikey);if(r.password_hint1){$("#password-hint1").val(r.password_hint1)}if(r.password_hint2){$("#password-hint2").val(r.password_hint2)}$("#ip-lock").val(r.ip_lock);$("#my-ip").text(r.my_ip);if(r.ip_lock_on==1){$("#ip-lock-on").prop("checked",true)}else{$("#ip-lock-on").prop("checked",false)}$('input[name="fee-policy"]').each(function(){if(parseInt($(this).val())==MyWallet.getFeePolicy()){$(this).attr("checked",true)}});if(MyWallet.getAlwaysKeepLocalBackup()){$('input[name="always-keep-local-backup"]').attr("checked",true)}else{$('input[name="always-keep-local-backup"]').attr("checked",false)}$('input[name="inactivity-logout-time"]').each(function(){if(parseInt($(this).val())==MyWallet.getLogoutTime()){$(this).attr("checked",true)}});if(r.email_verified==0){$("#verify-email").show();$("#email-verified").hide()}else{$("#verify-email").hide();$("#email-verified").show()}$("#my-ip").text(r.my_ip);var l="1";if(r.sms_number){var o=r.sms_number.split(" ");if(r.sms_number[0]=="+"&&o.length>1){l=o[0].substring(1);$(".wallet-sms").val(o[1])}else{$(".wallet-sms").val(r.sms_number)}}if(r.sms_verified==0){$(".sms-unverified").show();$(".sms-verified").hide()}else{$(".sms-verified").show().trigger("show");$(".sms-unverified").hide()}$.ajax({type:"GET",url:resource+"wallet/country_codes.html",success:function(z){$('select[class="wallet-sms-country-codes"]').html(z).val(l)},error:function(){MyWallet.makeNotice("error","misc-error","Error Downloading SMS Country Codes")}});var w=function(D,A,B){try{if(window.webkitNotifications&&navigator.userAgent.indexOf("Chrome")>-1){var z=webkitNotifications.checkPermission();if(z==1&&B){webkitNotifications.requestPermission(w)}else{if(z==0){D()}else{A()}}}else{if(window.Notification){if(Notification.permissionLevel()==="default"&&B){Notification.requestPermission(w)}else{if(window.Notification.permissionLevel()=="granted"){D()}else{A()}}}else{A()}}}catch(C){console.log(C);A()}};var n=$("#html5-notifications-checkbox");n.unbind().change(function(){if($(this).is(":checked")){w(function(){MyWallet.makeNotice("success","misc-success","HTML5 Notifications Enabled");MyWallet.setHTML5Notifications(true);MyWallet.backupWallet()},function(){MyWallet.makeNotice("error","misc-error","Error Enabling HTML5 Notifications");MyWallet.setHTML5Notifications(false);MyWallet.backupWallet()},true)}else{MyWallet.setHTML5Notifications(false);MyWallet.backupWallet()}});if(MyWallet.getHTML5Notifications()){n.attr("checked",true)}else{n.attr("checked",false)}},function(l){MyWallet.makeNotice("error","misc-error",l.responseText)})}function j(){e();var l=$("#update-password-modal");l.modal({keyboard:true,backdrop:"static",show:true});l.center();l.find(".btn.btn-primary").unbind().click(function(){l.modal("hide");var m=$.trim($("#password").val());var n=$.trim($("#password2").val());if(m!=n){MyWallet.makeNotice("error","misc-error","Passwords do not match.");return false}if(m.length==0||m.length<10||m.length>255){MyWallet.makeNotice("error","misc-error","Password length must be between least 10  & 255 characters");return false}MyWallet.setMainPassword(m)});l.find(".btn.btn-secondary").unbind().click(function(){l.modal("hide")})}function e(){$(".accordion-body").collapse("hide")}function g(m){var l=$("#double-password").val();var n=$("#double-password2").val();if(l==null||l.length==0||l.length<4||l.length>255){MyWallet.makeNotice("error","misc-error","Password must be 4 characters or more in length");return}if(l!=n){MyWallet.makeNotice("error","misc-error","Passwords do not match.");return}if(MyWallet.isCorrectMainPassword(l)){MyWallet.makeNotice("error","misc-error","Second password should not be the same as your main password.");return}MyWallet.setDoubleEncryption(m,l,function(){h()})}function d(){var l=$("#notifications-type");l.find(":checkbox").unbind().change(function(){var o=[];l.find(":checkbox:checked").each(function(){o.push($(this).val())});if(!o.length){o.push(0)}i("Updating Notifications Type","update-notifications-type",o.join("|"));l.find(".type-"+$(this).val()).toggle();MyWallet.get_history()});$("input[name=fee-policy]").unbind().change(function(){MyWallet.setFeePolicy($("input[name=fee-policy]:checked").val());MyWallet.backupWallet()});$('input[name="always-keep-local-backup"]').unbind().change(function(){MyWallet.setAlwaysKeepLocalBackup($(this).is(":checked"));try{localStorage.removeItem("payload")}catch(o){}MyWallet.backupWallet()});$("input[name=inactivity-logout-time]").unbind().change(function(){MyWallet.setLogoutTime(parseInt($(this).val()));MyWallet.backupWallet()});$("#password_mnemonic").unbind().on("show",function(){f()}).on("hide",function(){k()});$("#pairing_code").unbind().on("show",function(){var o=$("#device-qr-code");o.empty();MyWallet.makePairingQRCode(function(p){o.empty().append(p);setTimeout(function(){o.empty();e()},30000)})});$("#update-password-btn").unbind().click(function(){j()});$("#password-hint1").unbind().change(function(){i("Updating Main Password Hint","update-password-hint1",$(this).val())});$("#password-hint2").unbind().change(function(){i("Updating Second Password Hint","update-password-hint2",$(this).val())});$("#ip-lock-on").unbind().change(function(){i("Updating IP Lock","update-ip-lock-on",$(this).is(":checked"))});$("#ip-lock").unbind().change(function(){i("Updating Locked Ip Addresses","update-ip-lock",$(this).val())});$("#notifications-on").unbind().change(function(){i("Updating Notifications Settings","update-notifications-on",$(this).val())});$("#auto-email-backup").unbind().change(function(){i("Updating Auto Backup Settings","update-auto-email-backup",$(this).is(":checked"))});$("#never-save-auth-type").unbind().change(function(){i("Updating Auth Saving Settings","update-never-save-auth-type",$(this).is(":checked"))});$("#two-factor-select").unbind().change(function(){var o=parseInt($(this).val());i("Updating Two Factor Authentication","update-auth-type",o,function(){if(o==4){a()}else{if(o!=0&&!MyWallet.getAlwaysKeepLocalBackup()){try{localStorage.removeItem("payload")}catch(p){}}}MyWallet.setRealAuthType(o)});$(".two-factor").hide(200);$(".two-factor.t"+o).show(200)});var m="";$("#wallet-email-send").click(function(){m="";$("#wallet-email").trigger("change")});$("#wallet-email").unbind().change(function(p){var o=$.trim($(this).val());if(o.length==0){return}if(m==o){return}if(!b(o)){MyWallet.makeNotice("error","misc-error","Email address is not valid");return}i("Updating Email","update-email",o,function(){m=o},function(){m=""});m=o;$("#verify-email").show(200);$("#email-verified").hide()});$("#wallet-double-encryption-enable").unbind().click(function(o){e();g(true)});$("#wallet-double-encryption-disable").unbind().click(function(o){e();g(false)});$("#wallet-email-code").unbind().change(function(p){var o=$.trim($(this).val());if(o.length==0||o.length>255){MyWallet.makeNotice("error","misc-error","You must enter a code to verify");return}MyWallet.setLoadingText("Verifying Email");MyWallet.securePost("wallet",{payload:o,length:o.length,method:"verify-email"},function(q){MyWallet.makeNotice("success","misc-success",q);$("#verify-email").hide();$("#email-verified").show(200)},function(q){MyWallet.makeNotice("error","misc-error",q.responseText);$("#verify-email").show(200);$("#email-verified").hide()})});$(".wallet-sms-code").unbind().change(function(p){var o=$.trim($(this).val());if(o.length==0||o.length>255){MyWallet.makeNotice("error","misc-error","You must enter an SMS code to verify");return}MyWallet.setLoadingText("Verifying SMS Code");MyWallet.securePost("wallet",{payload:o,length:o.length,method:"verify-sms"},function(q){MyWallet.makeNotice("success","misc-success",q);$(".sms-unverified").hide();$(".sms-verified").show(200).trigger("show")},function(q){MyWallet.makeNotice("error","misc-error",q.responseText);$(".sms-verified").hide();$(".sms-unverified").show(200)})});var n="";$(".send-code").unbind().click(function(){n="";$(this).parent().find(".wallet-sms").trigger("change")});$('select[class="wallet-sms-country-codes"]').unbind().change(function(){n="";$(".wallet-sms").trigger("change")});$(".wallet-sms").unbind().change(function(){var o=$.trim($(this).val());if(o==null||o.length==0){return}if(o.charAt(0)!="+"){o="+"+$(".wallet-sms-country-codes").val()+o}if(n==o){return}n=o;i("Updating Cell Number","update-sms",o,function(){$(".sms-unverified").show(200);$(".sms-verified").hide()})});$("#run-key-check").unbind().click(function(){MyWallet.getSecondPassword(function(){try{MyWallet.checkAllKeys(true);MyWallet.backupWallet()}catch(o){MyWallet.makeNotice("error","misc-error",o)}})});$("#local_currency").unbind().change(function(){if(symbol!=symbol_local){toggleSymbol()}i("Updating Local Currency","update-currency",$(this).val(),function(){MyWallet.get_history()})});$("#language_select").unbind().change(function(){i("Updating Language","update-language",$(this).val(),function(){c(function(){window.location.reload()})})});$("#notifications-confirmations").unbind().change(function(o){i("Updating Notification Confirmations","update-notifications-confirmations",$(this).val())});$("#account-logging").unbind().on("show",function(){var p=$(this).find("table").hide();var o=p.find("tbody");MyWallet.securePost("wallet",{method:"list-logs",format:"json"},function(u){try{p.show();o.empty();if(u==null){throw"Failed to get backups"}var s=u.results;if(s.length==0){throw"No logs found"}for(var r in s){var q=s[r];o.append('<tr><td style="width:130px">'+dateToString(new Date(q.time))+'</td><td style="width:170px">'+q.action+'</td><td style="text-overflow: ellipsis;max-width:100px;overflow: hidden;">'+q.ip_address+"</td><td>"+q.user_agent+"</td></tr>")}}catch(t){MyWallet.makeNotice("error","misc-error",t)}},function(q){MyWallet.makeNotice("error","misc-error",q.responseText)})});$("#logging-level").unbind().change(function(o){$(".logl").hide();$(".logl.l"+$(this).val()).show();i("Updating Logging Level","update-logging-level",$(this).val(),function(){$("#account-logging").trigger("show")})});$("#wallet-yubikey").unbind().change(function(o){i("Updating Yubikey","update-yubikey",$(this).val())});$("#wallet-skype").unbind().change(function(o){i("Updating Skype Username","update-skype",$(this).val())});$("#wallet-boxcar").unbind().change(function(o){i("Updating Boxcar Email","update-boxcar",$(this).val())});$("#wallet-http-url").unbind().change(function(o){i("Updating HTTP url","update-http-url",$(this).val())});$("#wallet-phrase").unbind().change(function(p){var o=$.trim($(this).val());if(o==null||o.length==0||o.length>255){MyWallet.makeNotice("error","misc-error","You must enter a secret phrase");return}i("Updating Secret Phrase","update-phrase",o)});$("#wallet-alias").unbind().change(function(r){var q=$(this);var o=$.trim(q.val());q.val(q.val().replace(/[\.,\/ #!$%\^&\*;:{}=`~()]/g,""));var p=$.trim(q.val());if(p.length>0){$(".alias").fadeIn(200);$(".alias").text("https://blockchain.info/wallet/"+p)}i("Updating Alias","update-alias",p,null,function(){q.val(o)})})}};